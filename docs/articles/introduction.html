<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to PRE2DUP-R • PRE2DUPR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to PRE2DUP-R">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PRE2DUPR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../tutorials/Instruction_to_build_package_parameter.html">Package Parameters</a></li>
    <li><a class="dropdown-item" href="../tutorials/introduction_to_ATC_parameter.html">ATC Parameters</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Introduction to PRE2DUP-R</h1>
            
      

      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<p>This vignette provides a brief introduction to the
<code>PRE2DUPR</code> package, which is designed to construct treatment
periods from drug purhchases data with PRE2DUP algorithm. The package
includes functions for validating data and running the PRE2DUP.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>To install the <code>PRE2DUPR</code> package, you can use the
following command in R:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"piavat/PRE2DUP-R"</span><span class="op">)</span></span></code></pre></div>
<p>To use the <code>PRE2DUPR</code> package, you can start by loading it
into your R session:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">PRE2DUPR</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>The <code>PRE2DUPR</code> package comes with example datasets that
you can use to test the functionality of the PRE2DUP algorithm. The
datasets include:</p>
<ul>
<li>
<code>purchases_example</code>: A dataset containing drug purchase
records.</li>
<li>
<code>hospitalizations_example</code>: A dataset containing hospital
admission records.</li>
<li>
<code>package_parameters_example</code>: A dataset containing
package characteristics.</li>
<li>
<code>ATC_parameters_example</code>: A dataset containing ATC code
characteristics.</li>
</ul>
<p>All data types have associated functions to validate the input before
running <code>pre2dup</code>. These functions are called internally by
the program, so you don’t need to run them manually unless you want to
check your data beforehand.</p>
<p>It is recommended to run these checks in advance to detect and
correct errors more easily and efficiently. Note that the internal
checks in <code>pre2dup</code> will display only the first five rows
with detected errors. When run separately, all rows with issues can be
listed by adjusting the function parameter
<code>print_all = TRUE</code>.</p>
</div>
<div class="section level2">
<h2 id="drug-purchases-data">Drug purchases data<a class="anchor" aria-label="anchor" href="#drug-purchases-data"></a>
</h2>
<p>Drug purchases are records with information about the purchase of
drugs, including the person who made the purchase, the drug’s ATC code,
the package ID, the date of purchase, the number of packages purchased,
and the amount in DDDs (Defined Daily Doses).</p>
<div class="section level3">
<h3 id="data-validation">Data validation<a class="anchor" aria-label="anchor" href="#data-validation"></a>
</h3>
<p>Function <code>check_purchases</code> checks the data before running
the PRE2DUP algorithm. It ensures that the dataset meets the necessary
requirements for the algorithm to function correctly.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_purchases.html">check_purchases</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">purchases_example</span>, </span>
<span>                pre_person_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>                pre_atc <span class="op">=</span> <span class="st">"ATC"</span>,</span>
<span>                pre_package_id <span class="op">=</span> <span class="st">"vnr"</span>,</span>
<span>                pre_date <span class="op">=</span> <span class="st">"purchase_date"</span>,</span>
<span>                pre_ratio <span class="op">=</span> <span class="st">"n_packages"</span>,</span>
<span>                pre_ddd <span class="op">=</span> <span class="st">"amount"</span>,</span>
<span>                print_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>                </span>
<span><span class="co"># Checks passed for ‘purchases_example’</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="hospitalizations-data">Hospitalizations data<a class="anchor" aria-label="anchor" href="#hospitalizations-data"></a>
</h2>
<p>Hospitalizations are records of hospital admissions, including the
person ID, admission date, and discharge date. This data is used to
assess the impact of hospitalizations on drug exposure periods.</p>
<div class="section level3">
<h3 id="data-validation-1">Data validation<a class="anchor" aria-label="anchor" href="#data-validation-1"></a>
</h3>
<p>Function <code>check_hospitalizations</code> checks the data before
running the PRE2DUP algorithm.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_hospitalizations.html">check_hospitalizations</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">hospitalizations_example</span>,</span>
<span>                       hosp_person_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>                       hosp_admission <span class="op">=</span> <span class="st">"hospital_start"</span>,</span>
<span>                       hosp_discharge <span class="op">=</span> <span class="st">"hospital_end"</span>,</span>
<span>                       print_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>                </span>
<span><span class="co"># Checks passed for ‘hospitalizations_example’</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="package-parameters">Package parameters<a class="anchor" aria-label="anchor" href="#package-parameters"></a>
</h2>
<p>Package parameters are used to define the characteristics of drug
packages. The parameter file specifies the identifying number, ATC code,
and the minimum, usual, and maximum duration of a package, as well as
the usual and minimum dose in defined daily doses (DDDs).</p>
<p>Intruction show to create package parameters <a href="../tutorials/Instruction_to_build_package_parameter.html">Package
Parameters tutorial</a>.</p>
<div class="section level3">
<h3 id="data-validation-2">Data validation<a class="anchor" aria-label="anchor" href="#data-validation-2"></a>
</h3>
<p>Function <code>check_package_parameters</code> checks the data before
running the PRE2DUP algorithm.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_package_parameters.html">check_package_parameters</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">package_parameters_example</span>, </span>
<span>                         pack_atc <span class="op">=</span> <span class="st">"ATC"</span>,</span>
<span>                         pack_id <span class="op">=</span> <span class="st">"vnr"</span>,</span>
<span>                         pack_ddd_low <span class="op">=</span> <span class="st">"lower_ddd"</span>, </span>
<span>                         pack_ddd_usual <span class="op">=</span> <span class="st">"usual_ddd"</span>,</span>
<span>                         pack_dur_min <span class="op">=</span> <span class="st">"minimum_dur"</span>,</span>
<span>                         pack_dur_usual <span class="op">=</span> <span class="st">"usual_dur"</span>, </span>
<span>                         pack_dur_max <span class="op">=</span> <span class="st">"maximum_dur"</span>,</span>
<span>                         print_all <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>                </span>
<span><span class="co"># Checks passed for ‘package_parameters_example’</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="atc-parameters">ATC parameters<a class="anchor" aria-label="anchor" href="#atc-parameters"></a>
</h2>
<p>ATC parameters are used to define the characteristics of ATC codes
when package-specific information is not available. The ATC parameters
file specifies the partial or full ATC code, the lower limit of daily
dose, the usual daily dose, and the minimum and maximum allowed
treatment durations. Package example data ATC_parameters can be used as
such or as an example of how to create your own ATC code characteristics
dataset.</p>
<div class="section level3">
<h3 id="data-validation-3">Data validation<a class="anchor" aria-label="anchor" href="#data-validation-3"></a>
</h3>
<p>Function <code>check_atc_parameters</code> checks the ATC parameters
data before running the PRE2DUP algorithm.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_atc_parameters.html">check_atc_parameters</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">ATC_parameters</span>,</span>
<span>                     atc_class <span class="op">=</span> <span class="st">"partial_atc"</span>,</span>
<span>                     atc_ddd_low <span class="op">=</span> <span class="st">"lower_ddd_atc"</span>,</span>
<span>                     atc_ddd_usual <span class="op">=</span> <span class="st">"usual_ddd_atc"</span>, </span>
<span>                     atc_dur_min <span class="op">=</span> <span class="st">"minimum_dur_atc"</span>,</span>
<span>                     atc_dur_max <span class="op">=</span> <span class="st">"maximum_dur_atc"</span>,</span>
<span>                     print_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>                </span>
<span><span class="co"># Checks passed for ‘ATC_parameters’.</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="running-the-pre2dup">Running the PRE2DUP<a class="anchor" aria-label="anchor" href="#running-the-pre2dup"></a>
</h2>
<p>The PRE2DUP algorithm for creation of drug use periods is run using
the <code>pre2dup</code> function. This function will process your drug
purchase data, hospitalizations, package parameters, and ATC parameters
to estimate drug exposure.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pre2dup.html">pre2dup</a></span><span class="op">(</span></span>
<span>  pre_data <span class="op">=</span> <span class="va">purchases_example</span>,</span>
<span>  pre_person_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  pre_atc <span class="op">=</span> <span class="st">"ATC"</span>,</span>
<span>  pre_package_id <span class="op">=</span> <span class="st">"vnr"</span>,</span>
<span>  pre_date <span class="op">=</span> <span class="st">"purchase_date"</span>,</span>
<span>  pre_ratio <span class="op">=</span> <span class="st">"n_packages"</span>,</span>
<span>  pre_ddd <span class="op">=</span> <span class="st">"amount"</span>,</span>
<span>  package_parameters <span class="op">=</span> <span class="va">package_parameters_example</span>,</span>
<span>  pack_atc <span class="op">=</span> <span class="st">"ATC"</span>,</span>
<span>  pack_id <span class="op">=</span> <span class="st">"vnr"</span>,</span>
<span>  pack_ddd_low <span class="op">=</span> <span class="st">"lower_ddd"</span>,</span>
<span>  pack_ddd_usual <span class="op">=</span><span class="st">"usual_ddd"</span>,</span>
<span>  pack_dur_min <span class="op">=</span> <span class="st">"minimum_dur"</span>,</span>
<span>  pack_dur_usual <span class="op">=</span> <span class="st">"usual_dur"</span>,</span>
<span>  pack_dur_max <span class="op">=</span> <span class="st">"maximum_dur"</span>,</span>
<span>  atc_parameters <span class="op">=</span> <span class="va">ATC_parameters</span>,</span>
<span>  atc_class <span class="op">=</span> <span class="st">"partial_atc"</span>,</span>
<span>  atc_ddd_low <span class="op">=</span> <span class="st">"lower_ddd_atc"</span>,</span>
<span>  atc_ddd_usual <span class="op">=</span> <span class="st">"usual_ddd_atc"</span>,</span>
<span>  atc_dur_min <span class="op">=</span> <span class="st">"minimum_dur_atc"</span>,</span>
<span>  atc_dur_max <span class="op">=</span> <span class="st">"maximum_dur_atc"</span>,</span>
<span>  hosp_data <span class="op">=</span> <span class="va">hospitalizations_example</span>,</span>
<span>  hosp_person_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  hosp_admission <span class="op">=</span> <span class="st">"hospital_start"</span>,</span>
<span>  hosp_discharge <span class="op">=</span> <span class="st">"hospital_end"</span>,</span>
<span>  date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2025-01-01"</span>, <span class="st">"2025-12-31"</span><span class="op">)</span>,</span>
<span>  global_gap_max <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  global_min <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  global_max <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  global_max_single <span class="op">=</span> <span class="fl">150</span>,</span>
<span>  global_ddd_high <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  global_hosp_max <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  weight_past <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  weight_current <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  weight_next <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  weight_first_last <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  calculate_pack_dur_usual <span class="op">=</span> <span class="cn">T</span>,</span>
<span>  days_covered <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  post_process_perc <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># Step 1/6: Checking parameters and datasets...</span></span>
<span><span class="co"># Checks passed for ‘pre_data’</span></span>
<span><span class="co"># Checks passed for ‘package_parameters’</span></span>
<span><span class="co"># Checks passed for ‘atc_parameters’.</span></span>
<span><span class="co"># Checks passed for ‘hosp_data’</span></span>
<span><span class="co"># Preparing hospitalization data and merging overlapping hospitalizations.</span></span>
<span><span class="co"># Step 2/6: Calculating purchase durations...</span></span>
<span><span class="co"># Step 3/6: Stockpiling assessment...</span></span>
<span><span class="co"># Step 4/6: Calculating common package durations in data...</span></span>
<span><span class="co"># Refill lengths couldn't be re-estimated, probably due to too small data size.</span></span>
<span><span class="co"># Step 5/6: Preparing drug use periods...</span></span>
<span><span class="co"># Step 6/6: Post-processing drug use periods...</span></span>
<span><span class="co"># Current post processing percentage: 1</span></span>
<span><span class="co"># Drug use periods calculated. 7 periods created for 5 persons.  </span></span>
<span></span>
<span><span class="co"># Drug use periods are stored in the `periods` element of the output list.</span></span>
<span><span class="va">dup</span> <span class="op">&lt;-</span> <span class="va">outdata</span><span class="op">$</span><span class="va">periods</span></span>
<span><span class="va">dup</span></span>
<span><span class="co">#    period     id     ATC  dup_start    dup_end dup_days dup_hospital_days dup_n_purchases dup_last_purchase dup_total_DDD dup_temporal_average_DDDs</span></span>
<span><span class="co">#     &lt;int&gt; &lt;fctr&gt;  &lt;char&gt;     &lt;Date&gt;     &lt;Date&gt;    &lt;num&gt;             &lt;num&gt;           &lt;int&gt;            &lt;Date&gt;         &lt;num&gt;                     &lt;num&gt;</span></span>
<span><span class="co"># 1:      1      1 N05AH02 2025-01-01 2025-04-14      104                 0               3        2025-03-08         99.99                     0.961</span></span>
<span><span class="co"># 2:      2      2 N05AH02 2025-01-15 2025-04-28      104                 5               3        2025-03-22         99.99                     0.961</span></span>
<span><span class="co"># 3:      3      3 N05AH02 2025-02-01 2025-05-15      104                 0               3        2025-04-08         99.99                     0.961</span></span>
<span><span class="co"># 4:      4      3 N05AH04 2025-01-05 2025-08-26      233                 0               2        2025-04-15        200.00                     0.858</span></span>
<span><span class="co"># 5:      5      4 N05AH02 2025-01-10 2025-04-23      104                 0               3        2025-03-17         99.99                     0.961</span></span>
<span><span class="co"># 6:      6      4 N05AH04 2025-01-20 2025-09-10      233                 0               2        2025-04-30        200.00                     0.858</span></span>
<span><span class="co"># 7:      7      5 N05AH04 2025-01-01 2025-08-22      233                38               2        2025-04-11        200.00                     0.858</span></span>
<span></span>
<span><span class="co"># Package parameters with updated common durations is not returned, because the common durations were not calculated in this example.</span></span>
<span><span class="va">outdata</span><span class="op">$</span><span class="va">pack_info</span></span>
<span><span class="co"># NULL</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="workflow-when-using-estimated-usual-package-durations-from-data">Workflow when using estimated usual package durations from data<a class="anchor" aria-label="anchor" href="#workflow-when-using-estimated-usual-package-durations-from-data"></a>
</h2>
<p>The <code>pre2dup</code> function has an option to estimate the usual
package durations from the data. This is useful when you want to derive
package durations based on the actual purchase patterns in your dataset.
Set <code>calculate_pack_dur_usual = T</code>, run the program and
update package parameters based on common duration in data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make data so big, that it can calculate common durations</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, each <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">vnr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">30627</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">41738</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">ATC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"N05AH02"</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"N05AH04"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">d40</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-01"</span><span class="op">)</span>  <span class="op">+</span> <span class="fl">40</span><span class="op">*</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">d120</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-01-01"</span><span class="op">)</span>  <span class="op">+</span> <span class="fl">120</span><span class="op">*</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">purchase_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">d40</span>, <span class="va">d120</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">n_packages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">amount</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">33</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">purchases_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">vnr</span>, <span class="va">ATC</span>, <span class="va">purchase_date</span>, <span class="va">n_packages</span>, <span class="va">amount</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This example uses function default values, they can be changed to fit your needs.</span></span>
<span><span class="va">outdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pre2dup.html">pre2dup</a></span><span class="op">(</span></span>
<span>  pre_data <span class="op">=</span> <span class="va">purchases_data</span>,</span>
<span>  pre_person_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  pre_atc <span class="op">=</span> <span class="st">"ATC"</span>,</span>
<span>  pre_package_id <span class="op">=</span> <span class="st">"vnr"</span>,</span>
<span>  pre_date <span class="op">=</span> <span class="st">"purchase_date"</span>,</span>
<span>  pre_ratio <span class="op">=</span> <span class="st">"n_packages"</span>,</span>
<span>  pre_ddd <span class="op">=</span> <span class="st">"amount"</span>,</span>
<span>  package_parameters <span class="op">=</span> <span class="va">package_parameters_example</span>,</span>
<span>  pack_atc <span class="op">=</span> <span class="st">"ATC"</span>,</span>
<span>  pack_id <span class="op">=</span> <span class="st">"vnr"</span>,</span>
<span>  pack_ddd_low <span class="op">=</span> <span class="st">"lower_ddd"</span>,</span>
<span>  pack_ddd_usual <span class="op">=</span><span class="st">"usual_ddd"</span>,</span>
<span>  pack_dur_min <span class="op">=</span> <span class="st">"minimum_dur"</span>,</span>
<span>  pack_dur_usual <span class="op">=</span> <span class="st">"usual_dur"</span>,</span>
<span>  pack_dur_max <span class="op">=</span> <span class="st">"maximum_dur"</span>,</span>
<span>  atc_parameters <span class="op">=</span> <span class="va">ATC_parameters</span>,</span>
<span>  atc_class <span class="op">=</span> <span class="st">"partial_atc"</span>,</span>
<span>  atc_ddd_low <span class="op">=</span> <span class="st">"lower_ddd_atc"</span>,</span>
<span>  atc_ddd_usual <span class="op">=</span> <span class="st">"usual_ddd_atc"</span>,</span>
<span>  atc_dur_min <span class="op">=</span> <span class="st">"minimum_dur_atc"</span>,</span>
<span>  atc_dur_max <span class="op">=</span> <span class="st">"maximum_dur_atc"</span>,</span>
<span>  hosp_data <span class="op">=</span> <span class="va">hospitalizations_example</span>,</span>
<span>  hosp_person_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  hosp_admission <span class="op">=</span> <span class="st">"hospital_start"</span>,</span>
<span>  hosp_discharge <span class="op">=</span> <span class="st">"hospital_end"</span>,</span>
<span>  date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2020-01-01"</span>, <span class="st">"2025-12-31"</span><span class="op">)</span>,</span>
<span>  global_gap_max <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  global_min <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  global_max <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  global_max_single <span class="op">=</span> <span class="fl">150</span>,</span>
<span>  global_ddd_high <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  global_hosp_max <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  weight_past <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  weight_current <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  weight_next <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  weight_first_last <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  calculate_pack_dur_usual <span class="op">=</span> <span class="cn">T</span>,</span>
<span>  days_covered <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  post_process_perc <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># Step 1/6: Checking parameters and datasets...</span></span>
<span><span class="co"># Checks passed for ‘pre_data’</span></span>
<span><span class="co"># Checks passed for ‘package_parameters’</span></span>
<span><span class="co"># Checks passed for ‘atc_parameters’.</span></span>
<span><span class="co"># Checks passed for ‘hosp_data’</span></span>
<span><span class="co"># Preparing hospitalization data and merging overlapping hospitalizations.</span></span>
<span><span class="co"># Step 2/6: Calculating purchase durations...</span></span>
<span><span class="co"># Step 3/6: Stockpiling assessment...</span></span>
<span><span class="co"># Step 4/6: Calculating common package durations in data...</span></span>
<span><span class="co"># Step 5/6: Preparing drug use periods...</span></span>
<span><span class="co"># Step 6/6: Post-processing drug use periods...</span></span>
<span><span class="co"># Current post processing percentage: 1</span></span>
<span><span class="co"># Drug use periods calculated. 10 periods created for 5 persons.</span></span>
<span></span>
<span><span class="co"># Program returns periods, but not used for now </span></span>
<span><span class="va">dup</span> <span class="op">&lt;-</span> <span class="va">outdata</span><span class="op">$</span><span class="va">periods</span></span>
<span></span>
<span><span class="co"># Program returns updated package parameters</span></span>
<span><span class="va">updated_params</span> <span class="op">&lt;-</span> <span class="va">outdata</span><span class="op">$</span><span class="va">pack_info</span></span>
<span></span>
<span><span class="co"># Check new common durations</span></span>
<span><span class="va">updated_params</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">updated_params</span><span class="op">$</span><span class="va">common_duration</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="co">#     vnr     ATC product_name strength strength_num packagesize packsize_num drug_form_harmonized ddd_per_pack minimum_dur usual_dur maximum_dur lower_ddd usual_ddd common_duration</span></span>
<span><span class="co"># 6 30627 N05AH02      LEPONEX    100MG          100         100          100               TABLET     33.33333          25     33.33         100    0.3333      1.00              40</span></span>
<span><span class="co"># 8 41738 N05AH04    KETIPINOR    300MG          300      100FOL          100               TABLET     75.00000          50    100.00         200    0.3750      0.75             120</span></span>
<span></span>
<span><span class="co"># Make a new common duration column selecting the common duration from the updated package parameters by your choice</span></span>
<span><span class="va">updated_params</span><span class="op">$</span><span class="va">usual_duration_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">updated_params</span><span class="op">$</span><span class="va">common_duration</span><span class="op">)</span>,</span>
<span>  <span class="va">updated_params</span><span class="op">$</span><span class="va">common_duration</span>,</span>
<span>  <span class="va">updated_params</span><span class="op">$</span><span class="va">usual_dur</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run PRE2DUP with the updated package parameters</span></span>
<span><span class="va">outdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pre2dup.html">pre2dup</a></span><span class="op">(</span></span>
<span>  pre_data <span class="op">=</span> <span class="va">purchases_data</span>,</span>
<span>  pre_person_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  pre_atc <span class="op">=</span> <span class="st">"ATC"</span>,</span>
<span>  pre_package_id <span class="op">=</span> <span class="st">"vnr"</span>,</span>
<span>  pre_date <span class="op">=</span> <span class="st">"purchase_date"</span>,</span>
<span>  pre_ratio <span class="op">=</span> <span class="st">"n_packages"</span>,</span>
<span>  pre_ddd <span class="op">=</span> <span class="st">"amount"</span>,</span>
<span>  package_parameters <span class="op">=</span> <span class="va">updated_params</span>,</span>
<span>  pack_atc <span class="op">=</span> <span class="st">"ATC"</span>,</span>
<span>  pack_id <span class="op">=</span> <span class="st">"vnr"</span>,</span>
<span>  pack_ddd_low <span class="op">=</span> <span class="st">"lower_ddd"</span>,</span>
<span>  pack_ddd_usual <span class="op">=</span><span class="st">"usual_ddd"</span>,</span>
<span>  pack_dur_min <span class="op">=</span> <span class="st">"minimum_dur"</span>,</span>
<span>  pack_dur_usual <span class="op">=</span>  <span class="st">"usual_duration_new"</span>, <span class="co"># This is the new column</span></span>
<span>  pack_dur_max <span class="op">=</span> <span class="st">"maximum_dur"</span>,</span>
<span>  atc_parameters <span class="op">=</span> <span class="va">ATC_parameters</span>,</span>
<span>  atc_class <span class="op">=</span> <span class="st">"partial_atc"</span>,</span>
<span>  atc_ddd_low <span class="op">=</span> <span class="st">"lower_ddd_atc"</span>,</span>
<span>  atc_ddd_usual <span class="op">=</span> <span class="st">"usual_ddd_atc"</span>,</span>
<span>  atc_dur_min <span class="op">=</span> <span class="st">"minimum_dur_atc"</span>,</span>
<span>  atc_dur_max <span class="op">=</span> <span class="st">"maximum_dur_atc"</span>,</span>
<span>  hosp_data <span class="op">=</span> <span class="va">hospitalizations_example</span>,</span>
<span>  hosp_person_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  hosp_admission <span class="op">=</span> <span class="st">"hospital_start"</span>,</span>
<span>  hosp_discharge <span class="op">=</span> <span class="st">"hospital_end"</span>,</span>
<span>  date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2020-01-01"</span>, <span class="st">"2025-12-31"</span><span class="op">)</span>,</span>
<span>  global_gap_max <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  global_min <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  global_max <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  global_max_single <span class="op">=</span> <span class="fl">150</span>,</span>
<span>  global_ddd_high <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  global_hosp_max <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  weight_past <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  weight_current <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  weight_next <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  weight_first_last <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  calculate_pack_dur_usual <span class="op">=</span> <span class="cn">F</span>,<span class="co"># Done already</span></span>
<span>  days_covered <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  post_process_perc <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1/6: Checking parameters and datasets...</span></span>
<span><span class="co"># Checks passed for ‘pre_data’</span></span>
<span><span class="co"># Checks passed for ‘package_parameters’</span></span>
<span><span class="co"># Checks passed for ‘atc_parameters’.</span></span>
<span><span class="co"># Checks passed for ‘hosp_data’</span></span>
<span><span class="co"># Preparing hospitalization data and merging overlapping hospitalizations.</span></span>
<span><span class="co"># Step 2/6: Calculating purchase durations...</span></span>
<span><span class="co"># Step 3/6: Stockpiling assessment...</span></span>
<span><span class="co"># Step 4/6: Common package duration calculation was not selected in the parameters; skipping this step.</span></span>
<span><span class="co"># Step 5/6: Preparing drug use periods...</span></span>
<span><span class="co"># Step 6/6: Post-processing drug use periods...</span></span>
<span><span class="co"># Current post processing percentage: 1</span></span>
<span><span class="co"># Drug use periods calculated. 10 periods created for 5 persons.</span></span>
<span></span>
<span><span class="co"># The final output</span></span>
<span><span class="va">final_periods</span> <span class="op">&lt;-</span> <span class="va">outdata</span><span class="op">$</span><span class="va">periods</span></span>
<span><span class="va">final_periods</span></span>
<span><span class="co">#    period     id     ATC  dup_start    dup_end dup_days dup_hospital_days dup_n_purchases dup_last_purchase dup_total_DDD dup_temporal_average_DDDs</span></span>
<span><span class="co">#     &lt;int&gt; &lt;fctr&gt;  &lt;char&gt;     &lt;Date&gt;     &lt;Date&gt;    &lt;num&gt;             &lt;num&gt;           &lt;int&gt;            &lt;Date&gt;         &lt;num&gt;                     &lt;num&gt;</span></span>
<span><span class="co"># 1:      1      1 N05AH02 2020-02-10 2021-03-23      408                 0              10        2021-02-04           330                     0.809</span></span>
<span><span class="co"># 2:      2      1 N05AH04 2022-05-01 2025-09-05     1224                 0              10        2025-04-15           800                     0.654</span></span>
<span><span class="co"># 3:      3      2 N05AH02 2020-02-10 2021-03-23      408                 0              10        2021-02-04           330                     0.809</span></span>
<span><span class="co"># 4:      4      2 N05AH04 2022-05-01 2025-09-05     1224                 5              10        2025-04-15           800                     0.654</span></span>
<span><span class="co"># 5:      5      3 N05AH02 2020-02-10 2021-03-23      408                 0              10        2021-02-04           330                     0.809</span></span>
<span><span class="co"># 6:      6      3 N05AH04 2022-05-01 2025-09-05     1224                 0              10        2025-04-15           800                     0.654</span></span>
<span><span class="co"># 7:      7      4 N05AH02 2020-02-10 2021-03-23      408                 0              10        2021-02-04           330                     0.809</span></span>
<span><span class="co"># 8:      8      4 N05AH04 2022-05-01 2025-09-05     1224                 0              10        2025-04-15           800                     0.654</span></span>
<span><span class="co"># 9:      9      5 N05AH02 2020-02-10 2021-03-23      408                 0              10        2021-02-04           330                     0.809</span></span>
<span><span class="co"># 10:    10      5 N05AH04 2022-05-01 2025-09-05     1224                38              10        2025-04-15           800                     0.654</span></span></code></pre></div>
<p>For any questions or support, feel free to reach out to the package
maintainers</p>
<p>…</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pia Vattulainen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
